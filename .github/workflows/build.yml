name: Build Full App (Electron + Python Backend)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-app:
    runs-on: windows-latest

    steps:
      # --------------------------
      # 1️⃣ Checkout do código
      # --------------------------
      - name: Checkout código
        uses: actions/checkout@v4

      # --------------------------
      # 2️⃣ Backend (Python + PyInstaller)
      # --------------------------
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências do backend
        run: |
          cd plano-estudos-backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
        shell: pwsh

      - name: Limpar build anterior do backend
        run: |
          cd plano-estudos-backend
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue dist, build, *.spec, dist-ready
        shell: pwsh

      - name: Gerar backend.exe
        run: |
          cd plano-estudos-backend
          
          # Gerar executável
          pyinstaller --onefile --noconsole app.py

          # Criar pasta para arquivos prontos
          New-Item -ItemType Directory -Force -Path dist-ready

          # Copiar executável
          Copy-Item -Path "dist\app.exe" -Destination "dist-ready\backend.exe" -Force

          # Copiar banco de dados se existir
          if (Test-Path "data.db") {
              Copy-Item -Path "data.db" -Destination "dist-ready\" -Force
          }

          # Copiar planilha se existir
          if (Test-Path "Planilha TCU - Auditor - Acompanhamento.xlsx") {
              Copy-Item -Path "Planilha TCU - Auditor - Acompanhamento.xlsx" -Destination "dist-ready\" -Force
          }
        shell: pwsh

      # --------------------------
      # 3️⃣ Frontend + Electron
      # --------------------------
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Limpar build anterior do frontend
        run: |
          cd plano-estudos-frontend
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue node_modules, dist, release, backend
        shell: pwsh

      - name: Instalar dependências do frontend
        run: |
          cd plano-estudos-frontend
          npm install
        shell: pwsh

      - name: Copiar backend para recursos do Electron
        run: |
          New-Item -ItemType Directory -Force -Path plano-estudos-frontend\backend
          Copy-Item -Path plano-estudos-backend\dist-ready\* -Destination plano-estudos-frontend\backend\ -Force
        shell: pwsh

      - name: Build instalador Electron
        run: |
          cd plano-estudos-frontend
          npm run dist -- --win
        shell: pwsh

      # --------------------------
      # 4️⃣ Upload final
      # --------------------------
      - name: Upload instalador
        uses: actions/upload-artifact@v4
        with:
          name: full-installer
          path: plano-estudos-frontend/release/*.exe
